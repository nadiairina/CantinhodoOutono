<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrinho de Compras | Cantinho do Outono</title>
    <meta name="description" content="Reveja os itens no seu carrinho de compras e finalize a sua encomenda.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #fef9f5;
            color: #4A2B1A;
        }
        .btn-primary {
            background-color: #8B4513;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #A0522D;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .cart-icon-container {
            position: relative;
            display: inline-block;
        }
        .cart-item-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #A0522D;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .fade-in {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .fade-in.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .underline-hover-effect {
            display: inline-block;
            position: relative;
            cursor: pointer;
        }
        .underline-hover-effect::after {
            content: '';
            position: absolute;
            width: 100%;
            transform: scaleX(0);
            height: 2px;
            bottom: 0;
            left: 0;
            background-color: #A0522D;
            transform-origin: bottom right;
            transition: transform 0.25s ease-out;
        }
        .underline-hover-effect:hover::after {
            transform: scaleX(1);
            transform-origin: bottom left;
        }
    </style>
</head>
<body>
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex items-center justify-between">
            <a href="index.html" class="flex items-center space-x-2">
                <img src="logo.png" alt="Cantinho do Outono Logo" class="h-10">
                <span class="text-xl font-bold text-[#8B4513] hidden sm:block">Cantinho do Outono</span>
            </a>
            <div class="flex items-center space-x-6">
                <a href="index.html" class="text-gray-600 hover:text-[#8B4513] transition-colors underline-hover-effect">Início</a>
                <a href="produtos.html" class="text-gray-600 hover:text-[#8B4513] transition-colors underline-hover-effect">Produtos</a>
                <a href="sobre-nos.html" class="text-gray-600 hover:text-[#8B4513] transition-colors underline-hover-effect">Sobre Nós</a>
                <a href="contactos.html" class="text-gray-600 hover:text-[#8B4513] transition-colors underline-hover-effect">Contactos</a>
                <a href="carrinho.html" class="cart-icon-container text-gray-600 hover:text-[#8B4513] transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.182 1.953.522 2.766a15.228 15.228 0 002.528 1.487c.725.32 1.498.487 2.28.487a3 3 0 003-3H7a3 3 0 00-3 3 3 3 0 003-3h11.728a3 3 0 002.261-1.045c.42-.48.653-1.12.653-1.802V8.718a3 3 0 00-.735-1.996L17.72 4.414A3 3 0 0015.345 3H7a3 3 0 00-3 3 3 3 0 00-3-3m0 6a3 3 0 003-3H4.787a3 3 0 002.261 1.045c-.42.48-.653 1.12-.653 1.802v.282a3 3 0 00-3 3z" />
                    </svg>
                    <span id="cart-item-count" class="cart-item-count">0</span>
                </a>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-6 py-12">
        <section class="max-w-4xl mx-auto">
            <h1 class="text-3xl font-bold text-[#4A2B1A] mb-8 fade-in">Seu Carrinho</h1>

            <div class="bg-white p-6 md:p-10 rounded-lg shadow-lg fade-in">
                <div id="cart-items-container">
                    <p class="text-gray-500 text-center py-8" id="empty-cart-message">Seu carrinho está vazio.</p>
                </div>

                <div class="mt-8 border-t border-gray-200 pt-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-600">Subtotal:</span>
                        <span id="subtotal" class="font-semibold text-[#8B4513]">€0.00</span>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-gray-600">Envio:</span>
                        <span id="shipping-cost" class="font-semibold text-[#8B4513]">€2.50</span>
                    </div>
                    <div class="flex justify-between items-center font-bold text-xl border-t border-gray-300 pt-4">
                        <span>Total:</span>
                        <span id="cart-total" class="text-[#8B4513]">€0.00</span>
                    </div>
                </div>

                <div class="mt-6 text-right">
                    <a href="produtos.html" class="text-[#8B4513] hover:underline mr-4">Continuar Comprando</a>
                    <button id="checkout-button" class="btn-primary text-white font-bold py-3 px-8 rounded-full">
                        Finalizar Compra
                    </button>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-[#8B4513] text-white py-8 mt-12">
        <div class="text-center text-xs text-gray-400">
            <p>&copy; <span id="currentYear"></span> Cantinho do Outono. Todos os direitos reservados.</p>
            <p class="mt-1">Website desenvolvido por
                <a href="https://nadiairina.github.io/Nadia-Portfolio/"
                   target="_blank"
                   class="text-white hover:text-gray-300 transition duration-200 underline">
                    Nadia Irina
                </a>
            </p>
        </div>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-functions.js"></script>
    <script src="script.js"></script>
    <script>
        // Animações de scroll
        const faders = document.querySelectorAll('.fade-in');
        const appearOptions = { threshold: 0.25 };
        const appearOnScroll = new IntersectionObserver(function(entries, appearOnScroll) {
            entries.forEach(entry => {
                if (!entry.isIntersecting) {
                    return;
                } else {
                    entry.target.classList.add('visible');
                    appearOnScroll.unobserve(entry.target);
                }
            });
        }, appearOptions);

        faders.forEach(fader => {
            appearOnScroll.observe(fader);
        });

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "SUA_API_KEY_DO_FIREBASE", // Substitua pela sua chave de API
            authDomain: "SEU_AUTH_DOMAIN_DO_FIREBASE",
            projectId: "SEU_PROJECT_ID_DO_FIREBASE",
            storageBucket: "SEU_STORAGE_BUCKET_DO_FIREBASE",
            messagingSenderId: "SEU_MESSAGING_SENDER_ID_DO_FIREBASE",
            appId: "SEU_APP_ID_DO_FIREBASE"
        };
        firebase.initializeApp(firebaseConfig);

        const SHIPPING_COST = 2.50; // Custo de envio fixo

        // Funções para renderizar o carrinho
        function renderCart() {
            const cart = getCart();
            const cartItemsContainer = document.getElementById('cart-items-container');
            const emptyCartMessage = document.getElementById('empty-cart-message');

            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '';
                emptyCartMessage.classList.remove('hidden');
                document.getElementById('checkout-button').disabled = true;
                document.getElementById('checkout-button').classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                emptyCartMessage.classList.add('hidden');
                document.getElementById('checkout-button').disabled = false;
                document.getElementById('checkout-button').classList.remove('opacity-50', 'cursor-not-allowed');
                renderCartItems(cart);
            }
            updateTotals();
        }

        function renderCartItems(cart) {
            const cartItemsContainer = document.getElementById('cart-items-container');
            cartItemsContainer.innerHTML = '';

            cart.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'flex items-center justify-between py-4 border-b border-gray-200';
                itemElement.innerHTML = `
                    <div class="flex items-center">
                        <img src="${item.image}" alt="${item.name}" class="rounded-lg w-20 h-20 object-cover mr-4">
                        <div>
                            <h3 class="font-semibold">${item.name}</h3>
                            <p class="text-sm text-gray-500">Quantidade: ${item.quantity}</p>
                            <span class="font-bold text-[#8B4513]">€${(item.price * item.quantity).toFixed(2)}</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="increase-btn bg-gray-200 text-gray-700 p-1 rounded-full hover:bg-gray-300 transition-colors" data-id="${item.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <button class="decrease-btn bg-gray-200 text-gray-700 p-1 rounded-full hover:bg-gray-300 transition-colors" data-id="${item.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <button class="remove-from-cart-btn bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition-colors" data-id="${item.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                `;
                cartItemsContainer.appendChild(itemElement);
            });

            document.querySelectorAll('.increase-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.closest('button').dataset.id;
                    updateQuantity(id, 1);
                });
            });

            document.querySelectorAll('.decrease-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.closest('button').dataset.id;
                    updateQuantity(id, -1);
                });
            });

            document.querySelectorAll('.remove-from-cart-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.closest('button').dataset.id;
                    removeFromCart(id);
                });
            });
        }

        function updateTotals() {
            const cart = getCart();
            const subtotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
            const total = subtotal + SHIPPING_COST;
            
            document.getElementById('subtotal').textContent = `€${subtotal.toFixed(2)}`;
            document.getElementById('cart-total').textContent = `€${total.toFixed(2)}`;
        }

        renderCart();

        // Código de checkout do Stripe
        const checkoutButton = document.getElementById('checkout-button');
        checkoutButton.addEventListener('click', async () => {
            const cart = getCart();
            const itemsForCheckout = cart.map(item => ({
                id: item.id,
                name: item.name,
                price: item.price,
                quantity: item.quantity
            }));

            try {
                // Chamar a sua função do Firebase para criar o Payment Intent
                const createPaymentIntent = firebase.functions().httpsCallable('createPaymentIntent');
                const result = await createPaymentIntent({ items: itemsForCheckout });
                const clientSecret = result.data.clientSecret;

                // Confirmar o pagamento com o Stripe
                const stripe = Stripe('SUA_CHAVE_PÚBLICA_DO_STRIPE'); // Substitua pela sua chave pública
                const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret);

                if (error) {
                    console.error('Erro no pagamento:', error.message);
                    alert(`Ocorreu um erro: ${error.message}`);
                } else {
                    alert('Pagamento bem-sucedido!');
                    // Limpar o carrinho e redirecionar
                    saveCart([]); // Limpa o carrinho no localStorage
                    window.location.href = 'produtos.html'; // Redireciona para a página de produtos
                }
            } catch (error) {
                console.error('Erro na chamada da função do Firebase:', error);
                alert('Não foi possível processar o pagamento. Tente novamente mais tarde.');
            }
        });
    </script>
</body>
</html>
